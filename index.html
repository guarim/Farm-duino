<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FarmBot CNC ‚Äì Interface Professionnelle</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* =====================================================================
   GLOBAL STYLE ‚Äî UI MODERNE
   ===================================================================== */
body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: #eef1f5;
    margin: 0;
    padding: 0;
    color: #222;
}
header {
    background: linear-gradient(135deg, #0d6efd, #1a82ff);
    color: white;
    padding: 25px 40px;
    font-size: 28px;
    font-weight: 600;
    box-shadow: 0 4px 18px rgba(0,0,0,0.3);
}

/* =====================================================================
   LAYOUT
   ===================================================================== */
.container {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 25px;
    padding: 25px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.10);
    margin-bottom: 20px;
}

.card h2 {
    font-size: 19px;
    margin-bottom: 12px;
    color: #0d6efd;
}

input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #cdd4df;
    font-size: 14px;
    margin-top: 8px;
}

button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border: none;
    background: #0d6efd;
    color: white;
    font-size: 15px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.25s;
}
button:hover { background: #0a58ca; }

/* =====================================================================
   CANVAS GRILLE
   ===================================================================== */
#grilleCanvas {
    border: 2px solid #d0d4db;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}

/* =====================================================================
   ANIMATION AXES (X cyan, Y orange, Z violet)
   ===================================================================== */
.axis-box {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.axis-line {
    position: relative;
    height: 14px;
    border-radius: 20px;
    overflow: hidden;
    background: #d8dee8;
}

.axis-marker {
    position: absolute;
    top: 2px;
    left: 0;
    width: 20px;
    height: 10px;
    border-radius: 10px;
    animation: slide 2.8s infinite ease-in-out alternate;
}

/* X ‚Äî Cyan */
.axis-x .axis-marker {
    background: #00e0ff;
}

/* Y ‚Äî Orange */
.axis-y .axis-marker {
    background: #ffa300;
    animation-delay: .3s;
}

/* Z ‚Äî Violet */
.axis-z .axis-marker {
    background: #b600ff;
    animation-delay: .6s;
}

@keyframes slide {
    from { left: 4px; }
    to   { left: calc(100% - 24px); }
}

/* =====================================================================
   WEB SERIAL LOG
   ===================================================================== */
#serialLog {
    background: #0e1b29;
    color: #8ce1ff;
    font-family: Consolas, monospace;
    font-size: 13px;
    height: 160px;
    overflow-y: auto;
    border-radius: 10px;
    padding: 10px;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
}

</style>
</head>

<body>
<header><i class="fa-solid fa-seedling"></i> FarmBot CNC ‚Äì Interface Professionnelle</header>

<div class="container">

<!-- ============================================================
     PANNEAU GAUCHE
     ============================================================ -->
<div>

    <!-- WebSerial -->
    <div class="card">
        <h2><i class="fa-solid fa-usb"></i> Connexion Arduino</h2>
        <button onclick="connectSerial()">üîå Connecter via WebSerial</button>
        <button onclick="sendSerial('TEST')">üì§ Envoyer TEST</button>
        <div id="serialLog"></div>
    </div>

    <!-- Configuration -->
    <div class="card">
        <h2><i class="fa-solid fa-gear"></i> Param√®tres Surface</h2>
        Longueur L : <input type="number" id="longueur">
        Largeur W : <input type="number" id="largeur">
        Nx : <input type="number" id="nx">
        Ny : <input type="number" id="ny">
        <button onclick="genererGrille()">G√©n√©rer la grille</button>
    </div>

    <!-- Animation axes -->
    <div class="card">
        <h2><i class="fa-solid fa-arrows-alt"></i> Animation des axes</h2>

        <div class="axis-box">
            <div class="axis-line axis-x">
                <div class="axis-marker"></div>
            </div>
            <div class="axis-line axis-y">
                <div class="axis-marker"></div>
            </div>
            <div class="axis-line axis-z">
                <div class="axis-marker"></div>
            </div>
        </div>
    </div>

</div>

<!-- ============================================================
     PANNEAU DROIT
     ============================================================ -->
<div>

    <div class="card">
        <h2><i class="fa-solid fa-table-cells"></i> Grille de culture</h2>
        <canvas id="grilleCanvas" width="700" height="500"></canvas>
    </div>

</div>

</div>

<!-- =================================================================
     JAVASCRIPT
================================================================= -->
<script>

/* ============================================================
   1. WEB SERIAL ‚Äî Connexion propre & asynchrone
   ============================================================ */
let port;
let reader;
let inputDone;
let outputDone;
let outputStream;

async function connectSerial() {
    try {
        logSerial("üîç Demande de port s√©rie...");

        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        logSerial("‚úÖ Port ouvert !");

        // Output stream
        const encoder = new TextEncoderStream();
        outputDone = encoder.readable.pipeTo(port.writable);
        outputStream = encoder.writable;

        // Input stream
        const decoder = new TextDecoderStream();
        inputDone = port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        listenToPort();

    } catch (err) {
        logSerial("‚ùå Erreur WebSerial : " + err);
    }
}

async function listenToPort() {
    try {
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) logSerial("üì• " + value);
        }
    } catch (err) {
        logSerial("‚ùå Erreur lecture : " + err);
    }
}

async function sendSerial(msg) {
    if (!outputStream) {
        logSerial("‚ö†Ô∏è Non connect√© !");
        return;
    }
    const writer = outputStream.getWriter();
    await writer.write(msg + "\n");
    writer.releaseLock();
    logSerial("üì§ " + msg);
}

function logSerial(msg) {
    let box = document.getElementById("serialLog");
    box.innerHTML += msg + "<br>";
    box.scrollTop = box.scrollHeight;
}

/* ============================================================
   2. G√©n√©ration de la grille
   ============================================================ */
function genererGrille() {
    let c = document.getElementById("grilleCanvas");
    let ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    let nx = parseInt(document.getElementById("nx").value);
    let ny = parseInt(document.getElementById("ny").value);

    let w = c.width / nx;
    let h = c.height / ny;

    ctx.strokeStyle = "#8a9bb5";
    ctx.lineWidth = 1.2;

    for (let i = 0; i <= nx; i++) {
        ctx.beginPath();
        ctx.moveTo(i*w,0);
        ctx.lineTo(i*w,c.height);
        ctx.stroke();
    }
    for (let j = 0; j <= ny; j++) {
        ctx.beginPath();
        ctx.moveTo(0,j*h);
        ctx.lineTo(c.width,j*h);
        ctx.stroke();
    }
}

</script>
</body>
</html>

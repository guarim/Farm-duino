<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FarmBot CNC ‚Äî Interface compl√®te</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  /* ===========================
     GLOBAL ‚Äî Design moderne
     =========================== */
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --accent:#0d6efd;
    --muted:#6b7280;
    --success:#16a34a;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg),#e9eef7);
    color:#0f172a;
  }
  header{
    background: linear-gradient(135deg,var(--accent),#2aa0ff);
    color:white; padding:22px 28px; font-size:22px; font-weight:700;
    box-shadow: 0 6px 24px rgba(13,110,253,0.18);
    display:flex; gap:12px; align-items:center;
  }
  header .logo {font-size:1.4rem}
  main { padding:20px; display:grid; grid-template-columns:360px 1fr; gap:20px; }

  .card{
    background:var(--card); border-radius:12px; padding:16px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.06);
  }
  h3{ margin:0 0 10px 0; color:var(--accent); font-size:18px }

  input[type="number"], input[type="text"], select {
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db;
    margin-top:6px; margin-bottom:10px; font-size:14px;
  }
  button {
    background:var(--accent); color:white; border:0; padding:10px 12px; border-radius:10px;
    cursor:pointer; font-weight:600; transition:all .18s; display:inline-block;
  }
  button.ghost { background: transparent; color:var(--accent); border:1px solid rgba(13,110,253,0.15) }
  button.small { padding:6px 8px; font-size:13px; border-radius:8px }
  button:hover{ transform:translateY(-2px); box-shadow: 0 8px 18px rgba(13,110,253,0.12) }

  .row { display:flex; gap:10px; align-items:center }
  .col { display:flex; flex-direction:column; gap:8px }
  .muted { color:var(--muted); font-size:13px }

  /* ============= Grid canvas ============= */
  #gridWrap { position:relative; display:inline-block; }
  #gridCanvas { border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid #e6eefc; box-shadow:0 8px 20px rgba(12,64,255,0.04) }
  /* disk that indicates Z */
  #diskZ {
    position:absolute; width:28px; height:28px; border-radius:50%;
    transform:translate(-50%,-50%); pointer-events:none; box-shadow:0 6px 16px rgba(0,0,0,0.18);
    display:flex; align-items:center; justify-content:center; font-size:12px; color:white;
  }
  #diskZ.up { background:rgba(10,120,255,0.9) } /* bleu haut */
  #diskZ.down { background:rgba(220,40,40,0.92) } /* rouge bas */

  /* plant color badge */
  .plant-badge {
    display:flex; gap:8px; align-items:center; padding:6px; border-radius:10px; background:#fbfbff;
    border:1px solid #eef2ff;
  }
  .color-dot { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px }

  /* ============== Vision =============== */
  .visionRow { display:flex; gap:12px; align-items:flex-start }
  canvas.vision { border-radius:10px; border:1px solid #dbe7ff; background:#000; }

  /* ============== Axis animation ============== */
  .axisRow { display:flex; flex-direction:column; gap:10px; margin-top:8px }
  .axisLine { height:12px; background:#eef2ff; border-radius:12px; position:relative; overflow:hidden }
  .axisMarker { width:20px; height:12px; position:absolute; top:0; border-radius:8px; animation: slide 3s ease-in-out infinite alternate }
  .axisX .axisMarker { background: linear-gradient(90deg,#00e0ff,#00a3ff); animation-delay:0s }
  .axisY .axisMarker { background: linear-gradient(90deg,#ffb46b,#ff8b2b); animation-delay:.35s }
  .axisZ .axisMarker { background: linear-gradient(90deg,#b78bff,#8b43ff); animation-delay:.7s }
  @keyframes slide { from { left:6px } to { left: calc(100% - 26px) } }

  /* ============= Serial log ============= */
  #serialLog { background:#0b1220; color:#9be3ff; padding:10px; border-radius:10px; font-family:ui-monospace,monospace; height:160px; overflow:auto; font-size:13px }

  /* ============= Manual controls ============= */
  .manualGrid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; align-items:center }
  .manualGrid button { padding:10px }

  /* ============= badges and small UI ============= */
  .chip { padding:6px 10px; border-radius:999px; background:#f1f5f9; font-weight:600; color:#0f172a }
  .plant-list { display:flex; gap:8px; flex-wrap:wrap }

  /* responsive */
  @media (max-width:1000px){
    main { grid-template-columns: 1fr; padding:12px }
    #gridCanvas{ width:100% !important }
  }

</style>
</head>
<body>
<header>
  <span class="logo"><i class="fa-solid fa-seedling"></i></span>
  <div>
    FarmBot CNC ‚Äî Interface compl√®te
    <div class="muted" style="font-size:12px; font-weight:500">Pilotage ‚Ä¢ Vision ‚Ä¢ Arrosage ‚Ä¢ WebSerial ‚Ä¢ Gestion des plantes</div>
  </div>
</header>

<main>
  <!-- LEFT COLUMN: controls -->
  <section class="card" style="min-height:600px">
    <h3><i class="fa-solid fa-usb"></i> Connexion & Logs</h3>

    <div class="row">
      <button id="btnConnect">üîå Connecter Arduino</button>
      <button id="btnDisconnect" class="ghost">‚ùå D√©connecter</button>
    </div>

    <div style="margin-top:10px">
      <div class="muted">Port:</div>
      <div id="serialInfo" class="muted">non connect√©</div>
    </div>

    <h3 style="margin-top:14px"><i class="fa-solid fa-terminal"></i> Console s√©rie</h3>
    <div id="serialLog"></div>
    <div style="margin-top:8px" class="row">
      <input id="quickCmd" placeholder="Commande s√©rie (ex: G0 X0 Y0 Z0)">
      <button id="btnSendCmd">Envoyer</button>
    </div>

    <hr style="margin:12px 0">

    <h3><i class="fa-solid fa-gear"></i> Param√®tres de la surface</h3>
    <label>Longueur totale L (mm)</label>
    <input id="inputL" type="number" value="1200">
    <label>Largeur totale W (mm)</label>
    <input id="inputW" type="number" value="600">
    <label>Nombre cases Axe X (Nx)</label>
    <input id="inputNx" type="number" value="9" min="1">
    <label>Nombre cases Axe Y (Ny)</label>
    <input id="inputNy" type="number" value="4" min="1">
    <div class="row">
      <button id="btnGen">G√©n√©rer la grille</button>
      <button id="btnExport" class="ghost">Exporter CSV</button>
    </div>

    <h3 style="margin-top:12px"><i class="fa-solid fa-leaf"></i> Gestion 6 plantes</h3>
    <div class="muted">Entrez noms et choisissez couleur</div>
    <div id="plantInputs" style="margin-top:8px">
      <!-- dynamic -->
    </div>
    <div style="margin-top:8px" class="row">
      <button id="btnSavePlants">Sauvegarder</button>
      <button id="btnLoadPlants" class="ghost">Restaurer</button>
    </div>

    <h3 style="margin-top:14px"><i class="fa-solid fa-tint"></i> Arrosage & Humidit√©</h3>
    <div class="muted">Seuil d'humidit√© (%)</div>
    <input id="moistureThreshold" type="number" value="30" min="0" max="100">
    <div class="muted">Dur√©e d'arrosage (s)</div>
    <input id="waterDuration" type="number" value="20" min="1">
    <div class="muted">Intervalle automatique (minutes)</div>
    <input id="waterIntervalMins" type="number" value="120" min="1">
    <div style="margin-top:8px" class="row">
      <button id="btnStartAuto">D√©marrer surveillance</button>
      <button id="btnStopAuto" class="ghost">Arr√™ter</button>
    </div>

    <div style="margin-top:12px" class="muted">
      Remarque: l'interface envoie des commandes pour demander la lecture d'humidit√© √† l'Arduino et d√©clenche l'arrosage si < seuil.
    </div>

    <h3 style="margin-top:12px"><i class="fa-solid fa-wrench"></i> Aide - protocoles s√©rie</h3>
    <div class="muted" style="font-size:13px">
      Le frontend envoie / attend ces messages s√©rie :
      <ul style="margin:8px 0 0 18px">
        <li><b>G-code standard</b> (ex: <code>G0 X123 Y456 Z0</code>, <code>M3</code>, <code>M5</code>)</li>
        <li><b>READ_MOISTURE</b> ‚Üí l'Arduino doit r√©pondre : <code>MOISTURE i j value</code> (value en %)</li>
        <li><b>WATER_ON</b> et <b>WATER_OFF</b> pour piloter pompe d'arrosage (ou utilisez M-cmd)</li>
        <li><b>ACK</b> ou <b>OK</b> pour accuser r√©ception</li>
      </ul>
    </div>

  </section>

  <!-- RIGHT COLUMN: grid, vision, manual -->
  <section>
    <div class="card">
      <h3><i class="fa-solid fa-table-cells"></i> Grille interactive</h3>

      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
        <div>
          <span class="chip" id="gridInfo">Nx √ó Ny : 9 √ó 4</span>
          <span class="muted" style="margin-left:8px">Taille case calcul√©e automatiquement</span>
        </div>
        <div class="muted">Position: X <span id="posX">0</span> mm / Y <span id="posY">0</span> mm / Z <span id="posZ">0</span> mm</div>
      </div>

      <div id="gridWrap">
        <canvas id="gridCanvas" width="900" height="440"></canvas>
        <div id="diskZ" class="up">Z</div>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="btnGenSeedGcode">G√©n√©rer G-Code semis (toutes cases)</button>
        <button id="btnSendAll" class="ghost">Envoyer tout</button>
      </div>

      <div style="margin-top:8px">
        <div class="muted">Clique : s√©lectionner case (ou shift-clic pour affecter la plante s√©lectionn√©e)</div>
        <div style="margin-top:8px" id="plantSelector" class="plant-list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3><i class="fa-solid fa-gamepad"></i> Pilotage manuel & animation axes</h3>
      <div class="manualGrid" style="margin-bottom:8px">
        <button onclick="moveXY(0,-stepXY)">‚¨Ü Y+</button>
        <button onclick="moveXY(0,0)">‚óè</button>
        <button onclick="moveXY(0,stepXY)">‚¨á Y-</button>
        <button onclick="moveXY(-stepXY,0)">‚¨Ö X-</button>
        <button onclick="homeAll()">üè† Home</button>
        <button onclick="moveXY(stepXY,0)">‚û° X+</button>
        <button onclick="moveZ(stepZ)">üîº Z+</button>
        <button onclick="moveZ(0)">‚óè</button>
        <button onclick="moveZ(-stepZ)">üîΩ Z-</button>
      </div>

      <div style="margin-top:6px" class="row">
        <div>
          <div class="muted">Pas XY (mm)</div>
          <input id="stepXY" type="number" value="20">
        </div>
        <div>
          <div class="muted">Pas Z (mm)</div>
          <input id="stepZ" type="number" value="10">
        </div>
        <div>
          <div class="muted">Vitesse F (mm/min)</div>
          <input id="feedF" type="number" value="1000">
        </div>
      </div>

      <div class="axisRow" style="margin-top:12px">
        <div class="muted">Axes (animation)</div>
        <div class="axisLine axisX"><div class="axisMarker axisMarkerX"></div></div>
        <div class="axisLine axisY"><div class="axisMarker"></div></div>
        <div class="axisLine axisZ"><div class="axisMarker"></div></div>
      </div>

    </div>

    <div class="card visionRow" style="margin-top:14px">
      <div style="flex:0 0 340px">
        <h3><i class="fa-solid fa-camera"></i> Vision</h3>
        <video id="videoIn" width="320" height="240" autoplay playsinline style="border-radius:8px; border:1px solid #dbe7ff"></video>
      </div>
      <div style="flex:0 0 340px">
        <h3>Masque mauvaises herbes</h3>
        <canvas id="maskCanvas" width="320" height="240" class="vision"></canvas>
      </div>
      <div style="flex:1; padding-left:10px">
        <h3>R√©sultats</h3>
        <div class="muted">Pourcentage vert global : <b id="pcGreen">0</b>%</div>
        <div class="muted">Weeding actif : <b id="weedingActive">oui</b></div>
        <div style="margin-top:10px" class="row">
          <button id="btnStartCam">D√©marrer cam√©ra</button>
          <button id="btnStopCam" class="ghost">Arr√™ter</button>
        </div>
        <div style="margin-top:12px" class="muted">Exclusion: rayon 30 mm autour du centre de la case (ignore la plante).</div>
      </div>
    </div>

  </section>
</main>

<script>
/* ============================================================
   UTILITAIRES, √âTAT GLOBAL
   ============================================================ */
const $ = id => document.getElementById(id);

let L = Number($('inputL').value), W = Number($('inputW').value);
let Nx = Number($('inputNx').value), Ny = Number($('inputNy').value);
let cellL = L / Nx, cellW = W / Ny;
let grid = []; // grid[j][i] = {plant: index | null}
let plants = []; // array of {name,color}
let selectedPlant = null;
let gcodeBuffer = [];
let pos = {x:0,y:0,z:0};
let disk = $('diskZ');
let gridCanvas = $('gridCanvas');
let gctx = gridCanvas.getContext('2d');
let serialPort = null;
let textDecoder;
let reader;
let keepReading = false;
let writerStream;
let moistureAutoTimer = null;

/* ---------------- load defaults from localStorage if exist ---------------- */
function loadState(){
  const s = localStorage.getItem('farmbot_state_v1');
  if (!s) return false;
  try {
    const obj = JSON.parse(s);
    L = obj.L; W = obj.W; Nx = obj.Nx; Ny = obj.Ny;
    $('inputL').value = L; $('inputW').value = W; $('inputNx').value = Nx; $('inputNy').value = Ny;
    cellL = L / Nx; cellW = W / Ny;
    grid = obj.grid || [];
    plants = obj.plants || [];
    renderPlantInputs();
    renderPlantSelector();
    drawGrid();
    return true;
  } catch(e){console.warn(e); return false;}
}
loadState();

/* ---------------- save state ---------------- */
function saveState(){
  const obj = { L, W, Nx, Ny, grid, plants };
  localStorage.setItem('farmbot_state_v1', JSON.stringify(obj));
}

/* ============================================================
   PLANT MANAGER (6 plants)
   ============================================================ */
const defaultColors = ['#FF7A7A','#7AD1A4','#FFD36B','#9BC7FF','#C08CFF','#FFB0E0'];

function initDefaultPlants(){
  if (plants.length === 6) return;
  plants = [];
  const defaults = ['Plante 1','Plante 2','Plante 3','Plante 4','Plante 5','Plante 6'];
  for(let i=0;i<6;i++) plants.push({name: defaults[i], color: defaultColors[i]});
}
initDefaultPlants();
renderPlantInputs();
renderPlantSelector();

function renderPlantInputs(){
  const wrap = $('plantInputs');
  wrap.innerHTML = '';
  for(let i=0;i<6;i++){
    const p = plants[i] || {name:`Plante ${i+1}`, color:defaultColors[i]};
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='8px'; row.style.alignItems='center';

    const inp = document.createElement('input'); inp.type='text'; inp.value=p.name; inp.style.flex='1';
    inp.oninput = ()=> { plants[i].name = inp.value; renderPlantSelector(); saveState(); };

    const color = document.createElement('input'); color.type='color'; color.value = p.color;
    color.oninput = ()=> { plants[i].color = color.value; renderPlantSelector(); saveState(); };

    const pickBtn = document.createElement('button'); pickBtn.className='small'; pickBtn.textContent='S√©lection';
    pickBtn.onclick = ()=> { selectedPlant = i; highlightSelectedPlant(); };

    row.appendChild(inp); row.appendChild(color); row.appendChild(pickBtn);
    wrap.appendChild(row);
  }
}

function renderPlantSelector(){
  const sel = $('plantSelector'); sel.innerHTML='';
  for(let i=0;i<6;i++){
    const p = plants[i];
    const b = document.createElement('button');
    b.className='plant-badge';
    b.style.border = selectedPlant===i ? `2px solid ${p.color}` : '1px solid #eef2ff';
    b.onclick = ()=> { selectedPlant = i; highlightSelectedPlant(); };
    const dot = document.createElement('span'); dot.className='color-dot'; dot.style.background = p.color;
    const name = document.createElement('span'); name.textContent = p.name;
    b.appendChild(dot); b.appendChild(name);
    sel.appendChild(b);
  }
}

function highlightSelectedPlant(){
  renderPlantSelector();
}

/* ============================================================
   GRID MANAGEMENT
   ============================================================ */
function initGrid(){
  grid = [];
  for(let j=0;j<Ny;j++){
    const row = [];
    for(let i=0;i<Nx;i++) row.push({plant:null});
    grid.push(row);
  }
  saveState();
}
initGrid();

$('btnGen').addEventListener('click', ()=>{
  L = Number($('inputL').value); W = Number($('inputW').value);
  Nx = Math.max(1, Number($('inputNx').value)); Ny = Math.max(1, Number($('inputNy').value));
  cellL = L / Nx; cellW = W / Ny;
  $('gridInfo').textContent = `Nx √ó Ny : ${Nx} √ó ${Ny}`;
  initGrid();
  drawGrid();
  saveState();
});

$('btnExport').addEventListener('click', ()=> exportCSV());

gridCanvas.addEventListener('click', (ev)=>{
  const rect = gridCanvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const i = Math.floor(mx / (gridCanvas.width / Nx));
  const j = Math.floor(my / (gridCanvas.height / Ny));
  if (ev.shiftKey && selectedPlant !== null){
    grid[j][i].plant = selectedPlant;
    drawGrid(); saveState();
  } else {
    // simple click -> move to center and optionally seed
    goToCase(i,j, true); // true = move + update pos
  }
});

function drawGrid(){
  const cw = gridCanvas.width, ch = gridCanvas.height;
  gctx.clearRect(0,0,cw,ch);
  // background
  gctx.fillStyle = '#ffffff';
  gctx.fillRect(0,0,cw,ch);

  const w = cw / Nx, h = ch / Ny;
  // cells
  for(let j=0;j<Ny;j++){
    for(let i=0;i<Nx;i++){
      const cx = i*w + w/2, cy = j*h + h/2;
      // fill color if plant
      const pidx = grid[j][i].plant;
      if (pidx !== null && plants[pidx]){
        gctx.fillStyle = hexToRgba(plants[pidx].color, 0.18);
        gctx.fillRect(i*w+2, j*h+2, w-4, h-4);
        // plant name
        gctx.fillStyle = '#07304a';
        gctx.font = '12px Inter, sans-serif';
        gctx.fillText(plants[pidx].name, i*w + 8, j*h + 18);
      }
      // outline
      gctx.strokeStyle = '#e6eefc';
      gctx.strokeRect(i*w, j*h, w, h);
    }
  }
  // draw position marker
  updateDiskPosition();
}
drawGrid();

function hexToRgba(hex, alpha){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ============================================================
   POSITION / DISK UI
   ============================================================ */
function updateDiskPosition(){
  const cw = gridCanvas.width, ch = gridCanvas.height;
  // convert pos.x in mm to canvas px: x/L * width
  const px = (pos.x / L) * cw;
  const py = (pos.y / W) * ch;
  $('diskZ').style.left = `${Math.max(6, Math.min(cw-6, px))}px`;
  $('diskZ').style.top  = `${Math.max(6, Math.min(ch-6, py))}px`;
  if (pos.z < 0) { $('diskZ').classList.remove('up'); $('diskZ').classList.add('down'); } else { $('diskZ').classList.remove('down'); $('diskZ').classList.add('up'); }
  $('posX').textContent = pos.x.toFixed(0);
  $('posY').textContent = pos.y.toFixed(0);
  $('posZ').textContent = pos.z.toFixed(0);
}
updateDiskPosition();

/* ============================================================
   MOVE / G-CODE generation and send
   ============================================================ */
function sendSerialLine(line){
  if (!serialPort || !writerStream){ appendLog(`‚ö†Ô∏è Non connect√© : ${line}`); return; }
  const w = writerStream.getWriter();
  w.write(line + '\n');
  w.releaseLock();
  appendLog('‚Üí ' + line);
}

$('btnSendCmd').addEventListener('click', ()=>{
  const cmd = $('quickCmd').value.trim();
  if (!cmd) return;
  sendSerialLine(cmd);
});

function moveXY(dx, dy){
  pos.x += dx; pos.y += dy;
  // send G0
  const line = `G0 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)}`;
  sendSerialLine(line);
  updateDiskPosition();
}
function moveZ(dz){
  pos.z += dz;
  const line = `G0 Z${pos.z.toFixed(2)}`;
  sendSerialLine(line);
  updateDiskPosition();
}
function homeAll(){
  pos = {x:0,y:0,z:0};
  sendSerialLine('G0 X0 Y0 Z0');
  updateDiskPosition();
}

/* goto case i,j
   if doSeed true => only move to center and update pos (UI)
   if seedAction is true => also perform the semis sequence for that plant if present
*/
function goToCase(i,j, doMove=true, seedAction=false){
  const centerXmm = (i + 0.5) * cellL;
  const centerYmm = (j + 0.5) * cellW;
  if (doMove){
    sendSerialLine(`G0 Z0`); // safety
    sendSerialLine(`G0 X${centerXmm.toFixed(2)} Y${centerYmm.toFixed(2)} Z0`);
    pos.x = centerXmm; pos.y = centerYmm; pos.z = 0;
    updateDiskPosition();
  }
  if (seedAction){
    const pidx = grid[j][i].plant;
    if (pidx === null) { appendLog(`Case (${i},${j}) vide`); return; }
    seedAtCase(i,j,pidx);
  }
}

/* semis sequence for plant index p (0..5) at case i,j */
function seedAtCase(i,j,pIdx){
  const k = pIdx + 1;
  const zPrise = -400; // example
  const zDepth = -50;
  const centerXmm = (i + 0.5) * cellL;
  const centerYmm = (j + 0.5) * cellW;
  let seq = [
    'G0 Z0',
    `G0 X0 Y${100*k} Z-400`,
    `G1 Z${zPrise}`,
    'M3 P1',
    'G4 P200',
    'G0 Z0',
    `G0 X${centerXmm.toFixed(2)} Y${centerYmm.toFixed(2)} Z0`,
    `G1 Z${zDepth} F100`,
    'M5',
    'G0 Z0'
  ];
  seq.forEach(line => sendSerialLine(line));
}

/* Generate G-code for all sown cases and put in buffer */
$('btnGenSeedGcode').addEventListener('click', ()=>{
  gcodeBuffer = [];
  gcodeBuffer.push('; G-code g√©n√©r√© par interface FarmBot');
  gcodeBuffer.push('G0 Z0');
  for(let j=0;j<Ny;j++){
    for(let i=0;i<Nx;i++){
      const p = grid[j][i].plant;
      if (p === null) continue;
      const k = p+1;
      const cx = ((i+0.5)*cellL).toFixed(2);
      const cy = ((j+0.5)*cellW).toFixed(2);
      gcodeBuffer.push(`; semis ${plants[p].name} case (${i},${j})`);
      gcodeBuffer.push('G0 Z0');
      gcodeBuffer.push(`G0 X0 Y${100*k} Z-400`);
      gcodeBuffer.push(`G1 Z-405`);
      gcodeBuffer.push('M3 P1');
      gcodeBuffer.push('G4 P200');
      gcodeBuffer.push('G0 Z0');
      gcodeBuffer.push(`G0 X${cx} Y${cy} Z0`);
      gcodeBuffer.push('G1 Z-50 F100');
      gcodeBuffer.push('M5');
      gcodeBuffer.push('G0 Z0');
    }
  }
  appendLog("G-Code g√©n√©r√© (" + gcodeBuffer.length + " lignes). Appuyez Envoyer pour transmettre.");
});

/* send all gcode buffer lines */
$('btnSendAll').addEventListener('click', async ()=>{
  if (!writerStream){ appendLog("Non connect√©."); return; }
  for(const line of gcodeBuffer){
    sendSerialLine(line);
    await sleep(40);
  }
  appendLog('Transmission termin√©e.');
});

/* ============================================================
   SERIAL (WebSerial) ‚Äî connexion, lecture, √©criture
   ============================================================ */
$('btnConnect').addEventListener('click', connect);
$('btnDisconnect').addEventListener('click', disconnect);

async function connect(){
  if (!("serial" in navigator)){ alert("Web Serial non support√©"); return; }
  try {
    serialPort = await navigator.serial.requestPort();
    await serialPort.open({ baudRate: 115200 });
    appendLog("‚úÖ Port ouvert");
    $('serialInfo').textContent = "connect√©";

    const textEncoder = new TextEncoderStream();
    textEncoder.readable.pipeTo(serialPort.writable);
    writerStream = textEncoder.writable;

    textDecoder = new TextDecoderStream();
    serialPort.readable.pipeTo(textDecoder.writable);
    reader = textDecoder.readable.getReader();

    keepReading = true;
    readLoop();
  } catch(e){ appendLog("Erreur: " + e); }
}
async function readLoop(){
  while(keepReading){
    try{
      const { value, done } = await reader.read();
      if (done) break;
      if (value){
        handleSerialIn(value.trim());
      }
    } catch(e){ appendLog("Lecture erreur: "+e); break; }
  }
}
async function disconnect(){
  keepReading = false;
  try { if (reader) { await reader.cancel(); reader = null; } } catch(e){}
  try { if (serialPort) await serialPort.close(); } catch(e){}
  serialPort = null; writerStream = null;
  appendLog("üîå D√©connect√©");
  $('serialInfo').textContent = "non connect√©";
}

function appendLog(msg){
  const box = $('serialLog');
  const now = new Date(); const ts = now.toLocaleTimeString();
  box.innerHTML += `<div>[${ts}] ${escapeHtml(msg)}</div>`;
  box.scrollTop = box.scrollHeight;
}

/* parse incomming serial messages */
function handleSerialIn(text){
  appendLog('‚Üê ' + text);
  // parse moisture response lines like: MOISTURE i j value
  const parts = text.split(/\s+/);
  if (parts[0] === 'MOISTURE'){
    // MOISTURE i j val
    const i = parseInt(parts[1]), j = parseInt(parts[2]), val = parseFloat(parts[3]);
    appendLog(`Lecture humidit√© case (${i},${j}) = ${val}%`);
    // store result and apply logic if watering waiting
    // we use a simple in-memory map
    moistureResponses[`${i},${j}`] = val;
  }
  if (parts[0] === 'OK' || parts[0] === 'ACK') {
    // just log
  }
}

/* ============================================================
   MOISTURE / ARROSAGE FLOW (frontend scheduler)
   ============================================================ */
let moistureResponses = {}; // map "i,j" -> percent
let autoMode = false;

$('btnStartAuto').addEventListener('click', ()=>{
  const mins = Number($('waterIntervalMins').value);
  if (autoMode) return;
  autoMode = true;
  appendLog(`D√©marrage surveillance automatique toutes les ${mins} minutes`);
  // start immediate then schedule
  runMoistureCycle();
  moistureAutoTimer = setInterval(runMoistureCycle, mins * 60 * 1000);
  $('btnStartAuto').disabled = true; $('btnStopAuto').disabled = false;
});

$('btnStopAuto').addEventListener('click', ()=>{
  autoMode = false; clearInterval(moistureAutoTimer);
  appendLog('Surveillance automatique arr√™t√©e');
  $('btnStartAuto').disabled = false; $('btnStopAuto').disabled = true;
});

/* run one full moisture cycle: iterate over planted cases, move and request moisture read */
async function runMoistureCycle(){
  appendLog('--- D√©marrage cycle humidit√© ---');
  for(let j=0;j<Ny;j++){
    for(let i=0;i<Nx;i++){
      if (grid[j][i].plant === null) continue;
      // move to case center
      const cx = (i + 0.5) * cellL;
      const cy = (j + 0.5) * cellW;
      sendSerialLine(`G0 Z0`);
      sendSerialLine(`G0 X${cx.toFixed(2)} Y${cy.toFixed(2)} Z0`);
      await sleep(300); // small wait for Arduino to move (should be replaced by ACK / position confirmation)
      // ask for moisture read (protocol)
      appendLog(`Demande humidit√© case (${i},${j})`);
      // store sentinel
      delete moistureResponses[`${i},${j}`];
      sendSerialLine(`READ_MOISTURE ${i} ${j}`);
      // wait for response with timeout
      let val = await waitForMoistureResponse(i,j, 8000); // 8s timeout
      if (val === null) {
        appendLog(`‚ö†Ô∏è Pas de r√©ponse humidit√© pour (${i},${j})`);
        continue;
      }
      const threshold = Number($('moistureThreshold').value);
      if (val < threshold){
        appendLog(`Humidit√© ${val}% < seuil ${threshold}% ‚Üí ARROSAGE`);
        // send water ON
        sendSerialLine('WATER_ON');
        const dur = Number($('waterDuration').value);
        await sleep(dur*1000);
        sendSerialLine('WATER_OFF');
        appendLog(`Arrosage ${dur}s effectu√© pour (${i},${j})`);
      } else {
        appendLog(`Humidit√© ${val}% >= seuil ‚Äî pas d'arrosage`);
      }
      await sleep(300);
    }
  }
  appendLog('--- Fin cycle humidit√© ---');
}

/* wait for moisture response from map */
function waitForMoistureResponse(i,j,timeoutMs=5000){
  return new Promise((resolve)=>{
    const key = `${i},${j}`;
    const start = Date.now();
    const check = () => {
      if (moistureResponses.hasOwnProperty(key)){
        resolve(moistureResponses[key]);
      } else if (Date.now() - start > timeoutMs){
        resolve(null);
      } else {
        setTimeout(check, 200);
      }
    };
    check();
  });
}

/* ============================================================
   VISION (webcam) ‚Äî capture + simple HSV green mask + exclusion circle
   ============================================================ */
let camStream = null;
$('btnStartCam').addEventListener('click', startCamera);
$('btnStopCam').addEventListener('click', stopCamera);

async function startCamera(){
  try {
    camStream = await navigator.mediaDevices.getUserMedia({video:{width:320,height:240}});
    $('videoIn').srcObject = camStream;
    $('videoIn').play();
    processVideoFrame();
  } catch(e){ alert('Erreur cam√©ra: '+e); }
}

function stopCamera(){
  if (camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
}

/* process video frames, create HSV mask, exclude circle radius 30mm mapped to pixels */
function processVideoFrame(){
  if (!camStream) return;
  const v = $('videoIn');
  const maskCanvas = $('maskCanvas');
  const mctx = maskCanvas.getContext('2d');
  mctx.drawImage(v,0,0, maskCanvas.width, maskCanvas.height);
  const img = mctx.getImageData(0,0,maskCanvas.width, maskCanvas.height);
  const data = img.data;
  let greenCount = 0;
  const totalPixels = maskCanvas.width * maskCanvas.height;

  // compute px radius for 30 mm roughly
  const pxPerMmX = maskCanvas.width / L;
  const pxPerMmY = maskCanvas.height / W;
  const pxPerMm = (pxPerMmX + pxPerMmY)/2;
  const Rpx = Math.round(pxPerMm * 30);
  const cx = Math.round(maskCanvas.width / 2);
  const cy = Math.round(maskCanvas.height / 2);

  for(let i=0;i<data.length;i+=4){
    const r = data[i], g = data[i+1], b = data[i+2];
    // convert to HSV approx
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const vval = max;
    const delta = max - min;
    let h = 0;
    if (delta!==0){
      if (max === r) h = 60 * (((g - b) / delta) % 6);
      else if (max === g) h = 60 * (((b - r) / delta) + 2);
      else h = 60 * (((r - g) / delta) + 4);
      if (h<0) h+=360;
    }
    const s = max === 0 ? 0 : (delta / max) * 100;
    const val = (vval / 255) * 100;
    const isGreen = (h >= 35 && h <= 100 && s >= 30 && val >= 20);
    const pxIndex = (i/4) % maskCanvas.width;
    const pyIndex = Math.floor((i/4)/maskCanvas.width);
    // exclusion circle
    const dx = pxIndex - cx, dy = pyIndex - cy;
    const dist2 = dx*dx + dy*dy;
    if (isGreen && dist2 > Rpx*Rpx){
      // highlight green outside exclusion
      data[i]=0; data[i+1]=255; data[i+2]=0; data[i+3]=255;
      greenCount++;
    } else {
      // black
      data[i]=0; data[i+1]=0; data[i+2]=0; data[i+3]=255;
    }
  }
  mctx.putImageData(img,0,0);
  // draw exclusion circle overlay
  mctx.beginPath(); mctx.strokeStyle='rgba(0,120,255,0.7)'; mctx.lineWidth=2;
  mctx.arc(cx,cy,Rpx,0,Math.PI*2); mctx.stroke();

  const pc = Math.round((greenCount/totalPixels)*100);
  $('pcGreen').textContent = pc;
  $('weedingActive').textContent = pc <= 35 ? 'oui' : 'non (d√©sactiv√©)';

  requestAnimationFrame(processVideoFrame);
}

/* ============================================================
   HELPERS
   ============================================================ */
function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* simple CSV export */
function exportCSV(){
  let rows = [['i','j','x_mm','y_mm','plantIndex','plantName','plantColor']];
  for(let j=0;j<Ny;j++){
    for(let i=0;i<Nx;i++){
      const p = grid[j][i].plant;
      const x = ((i+0.5)*cellL).toFixed(2);
      const y = ((j+0.5)*cellW).toFixed(2);
      rows.push([i,j,x,y, p===null?'':p, p===null?'':(plants[p] ? plants[p].name : ''), p===null?'':(plants[p] ? plants[p].color : '')]);
    }
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='farmgrid_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ============================================================
   BOOTSTRAP: wire up basic buttons and defaults
   ============================================================ */
$('btnSavePlants').addEventListener('click', ()=>{
  saveState(); appendLog('Plantes et grille sauvegard√©es localement.');
});
$('btnLoadPlants').addEventListener('click', ()=>{
  loadState(); appendLog('√âtat restaur√© (si disponible).');
});
$('btnStartCam').addEventListener('click', ()=> startCameraIfNeeded());
$('btnStopCam').addEventListener('click', ()=> stopCamera());
$('btnGenSeedGcode').addEventListener('click', ()=> { $('btnSendAll').disabled=false; appendLog('G-Code pr√™t. Cliquez Envoyer pour transmettre.'); });

function startCameraIfNeeded(){ if (!camStream) startCamera(); }

/* initial UI populate */
$('gridInfo').textContent = `Nx √ó Ny : ${Nx} √ó ${Ny}`;
renderPlantSelector();
drawGrid();

/* expose goToCase to console for debug */
window.goToCase = goToCase;
window.seedAtCase = seedAtCase;
window.saveState = saveState;
window.loadState = loadState;

</script>
</body>
</html>

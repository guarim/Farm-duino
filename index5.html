<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>FarmBot Control Center</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; }
        
        /* Layout Principal */
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        /* Panneaux */
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { width: 300px; }
        .visualization { position: relative; } /* Pour superposer le robot */
        .vision-panel { display: flex; flex-direction: column; gap: 10px; }

        /* Inputs & Boutons */
        input, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.stop { background: #dc3545; }

        /* Canvas */
        canvas { border: 1px solid #ccc; background: #fff; }
        .video-container { display: flex; gap: 10px; }

        /* Console Debug */
        #debug-log { width: 100%; height: 100px; background: #222; color: #0f0; font-family: monospace; overflow-y: scroll; padding: 10px; margin-top: 20px; }
        
        /* Indicateurs */
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; }
        .status-z-high { background: #007bff; } /* Bleu */
        .status-z-low { background: #dc3545; }  /* Rouge */

    </style>
</head>
<body>

    <h1>üöú FarmBot Dashboard</h1>

    <div class="main-container">
        <div class="panel controls">
            <h3>‚öôÔ∏è Param√®tres</h3>
            <label>Longueur (L): <input type="number" id="inpL" value="1000"> mm</label>
            <label>Largeur (W): <input type="number" id="inpW" value="500"> mm</label>
            <label>Cases X (Nx): <input type="number" id="inpNx" value="5"></label>
            <label>Cases Y (Ny): <input type="number" id="inpNy" value="2"></label>
            <button onclick="initGrid()">G√©n√©rer Grille</button>
            <hr>
            <h3>üå± Affectation</h3>
            <select id="plantSelector">
                <option value="Tomate">üçÖ Tomate (1)</option>
                <option value="Salade">ü•¨ Salade (2)</option>
                <option value="Radis">ü•î Radis (3)</option>
            </select>
            <p>Cliquez sur une case pour affecter.</p>
            <hr>
            <h3>üöÄ Commandes</h3>
            <button onclick="startPlantingSequence()">Lancer S√©quence Semis</button>
            <button class="stop" onclick="emergencyStop()">STOP URGENCE</button>
        </div>

        <div class="panel visualization">
            <h3>üó∫Ô∏è Carte & Position Robot</h3>
            <canvas id="farmCanvas" width="500" height="250"></canvas>
            <div id="robot-stats">
                Pos: X<span id="dspX">0</span> Y<span id="dspY">0</span> Z<span id="dspZ">0</span>
                <span id="zStatus" class="status-badge status-z-high">Z-HAUT</span>
            </div>
        </div>

        <div class="panel vision-panel">
            <h3>üì∑ Vision & D√©sherbage</h3>
            <button onclick="startCamera()">Activer Cam√©ra</button>
            <div class="video-container">
                <div>
                    <small>Flux R√©el</small><br>
                    <video id="webcam" width="320" height="240" autoplay playsinline style="display:none;"></video>
                    <canvas id="canvasVideo" width="320" height="240"></canvas>
                </div>
                <div>
                    <small>Masque (Vert d√©tect√©)</small><br>
                    <canvas id="canvasMask" width="320" height="240"></canvas>
                </div>
            </div>
            <div id="weed-stats">Herbes d√©tect√©es: 0%</div>
        </div>
    </div>

    <div id="debug-log">Initialisation syst√®me...</div>

<script>
    // --- VARIABLES GLOBALES ---
    let config = { L: 1000, W: 500, Nx: 5, Ny: 2 };
    let gridData = []; // Stocke {type, x, y}
    
    // √âtat du Robot (Simulation de ce que l'Arduino renvoie)
    let robot = { 
        x: 0, // mm
        y: 0, // mm
        z: 0, // 0 = haut, -1 = bas
        targetX: 0, 
        targetY: 0
    };

    const canvas = document.getElementById('farmCanvas');
    const ctx = canvas.getContext('2d');
    const logDiv = document.getElementById('debug-log');

    // --- 1. GESTION GRILLE & AFFICHAGE ---

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
    }

    function initGrid() {
        config.L = parseInt(document.getElementById('inpL').value);
        config.W = parseInt(document.getElementById('inpW').value);
        config.Nx = parseInt(document.getElementById('inpNx').value);
        config.Ny = parseInt(document.getElementById('inpNy').value);

        gridData = [];
        for(let i=0; i<config.Nx; i++) {
            gridData[i] = [];
            for(let j=0; j<config.Ny; j++) {
                gridData[i][j] = { type: null }; // Vide au d√©but
            }
        }
        drawFarm();
        log(`Grille initialis√©e : ${config.Nx}x${config.Ny}`);
    }

    // Gestion du clic pour affecter les plantes
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Conversion pixel -> case
        const caseW = canvas.width / config.Nx;
        const caseH = canvas.height / config.Ny;
        
        const i = Math.floor(mouseX / caseW);
        const j = Math.floor(mouseY / caseH);

        if(i >= 0 && i < config.Nx && j >= 0 && j < config.Ny) {
            const plant = document.getElementById('plantSelector').value;
            gridData[i][j].type = plant;
            drawFarm();
            log(`Case (${i},${j}) affect√©e : ${plant}`);
        }
    });

    function drawFarm() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const caseW = canvas.width / config.Nx;
        const caseH = canvas.height / config.Ny;

        // 1. Dessiner la grille et les plantes
        for(let i=0; i<config.Nx; i++) {
            for(let j=0; j<config.Ny; j++) {
                const x = i * caseW;
                const y = j * caseH;
                
                ctx.strokeStyle = "#ccc";
                ctx.strokeRect(x, y, caseW, caseH);

                if (gridData[i] && gridData[i][j].type) {
                    ctx.fillStyle = "#e0f7fa"; // Fond plante
                    ctx.fillRect(x+2, y+2, caseW-4, caseH-4);
                    ctx.fillStyle = "#006064";
                    ctx.font = "14px Arial";
                    ctx.fillText(gridData[i][j].type.substring(0,2), x + caseW/2 - 10, y + caseH/2 + 5);
                }
            }
        }

        // 2. Dessiner le ROBOT (Disque transparent)
        // Conversion coordonn√©es mm -> pixels canvas
        const scaleX = canvas.width / config.L;
        const scaleY = canvas.height / config.W;
        
        const rx = robot.x * scaleX;
        const ry = robot.y * scaleY;

        ctx.beginPath();
        ctx.arc(rx, ry, 20, 0, 2 * Math.PI); // Rayon 20px
        
        // Couleur selon Z
        if(robot.z >= 0) {
            ctx.fillStyle = "rgba(0, 123, 255, 0.5)"; // BLEU Transparent (Haut)
            ctx.strokeStyle = "blue";
        } else {
            ctx.fillStyle = "rgba(220, 53, 69, 0.5)"; // ROUGE Transparent (Bas/Travail)
            ctx.strokeStyle = "red";
        }
        
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.stroke();

        // R√©ticule
        ctx.beginPath(); ctx.moveTo(rx-5, ry); ctx.lineTo(rx+5, ry); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(rx, ry-5); ctx.lineTo(rx, ry+5); ctx.stroke();
    }

    // Fonction de simulation pour faire bouger le point (remplacerait la lecture s√©rie)
    function simulateRobotMovement() {
        // Interpolation simple vers la cible
        const step = 5; 
        if(Math.abs(robot.x - robot.targetX) > step) robot.x += (robot.targetX > robot.x ? step : -step);
        if(Math.abs(robot.y - robot.targetY) > step) robot.y += (robot.targetY > robot.y ? step : -step);
        
        // Mise √† jour affichage DOM
        document.getElementById('dspX').innerText = Math.round(robot.x);
        document.getElementById('dspY').innerText = Math.round(robot.y);
        document.getElementById('dspZ').innerText = robot.z;
        
        const zBadge = document.getElementById('zStatus');
        if(robot.z >= 0) {
            zBadge.className = "status-badge status-z-high"; zBadge.innerText = "Z-HAUT";
        } else {
            zBadge.className = "status-badge status-z-low"; zBadge.innerText = "Z-BAS";
        }

        drawFarm();
        requestAnimationFrame(simulateRobotMovement);
    }
    simulateRobotMovement(); // D√©marrer boucle de rendu

    // --- 2. VISION PAR ORDINATEUR ---
    
    let video = document.getElementById('webcam');
    let canvasV = document.getElementById('canvasVideo');
    let ctxV = canvasV.getContext('2d');
    let canvasM = document.getElementById('canvasMask');
    let ctxM = canvasM.getContext('2d');
    let streaming = false;

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
            streaming = true;
            processVideo();
        })
        .catch(function(err) {
            log("Erreur Cam√©ra: " + err);
        });
    }

    function processVideo() {
        if (!streaming) return;

        // 1. Dessiner vid√©o sur canvas
        ctxV.drawImage(video, 0, 0, 320, 240);
        let frame = ctxV.getImageData(0, 0, 320, 240);
        let l = frame.data.length / 4;
        
        // Cr√©er image masque
        let maskData = ctxM.createImageData(320, 240);

        let greenCount = 0;
        let totalPixels = 0;

        // Centre de l'image (position th√©orique de la buse)
        let cx = 160; 
        let cy = 120; 
        let exclusionRadius = 30; // 30px ~ 4cm selon zoom

        for (let i = 0; i < l; i++) {
            let r = frame.data[i * 4 + 0];
            let g = frame.data[i * 4 + 1];
            let b = frame.data[i * 4 + 2];

            // Coordonn√©es du pixel actuel
            let px = i % 320;
            let py = Math.floor(i / 320);

            // Calcul distance au centre
            let dist = Math.sqrt((px-cx)*(px-cx) + (py-cy)*(py-cy));

            let isGreen = false;
            
            // --- LOGIQUE D'EXCLUSION DU CENTRE ---
            if (dist > exclusionRadius) {
                // D√©tection de vert simple (G dominant)
                // Pour plus de pr√©cision, convertir en HSV est mieux, mais ceci est plus rapide en JS pur
                if (g > r + 20 && g > b + 20 && g > 60) {
                    isGreen = true;
                }
            }

            if (isGreen) {
                // Pixel Vert d√©tect√© -> Blanc dans le masque (ou vert fluo)
                maskData.data[i * 4 + 0] = 0;
                maskData.data[i * 4 + 1] = 255;
                maskData.data[i * 4 + 2] = 0;
                maskData.data[i * 4 + 3] = 255; // Alpha
                greenCount++;
            } else {
                // Noir
                maskData.data[i * 4 + 0] = 0;
                maskData.data[i * 4 + 1] = 0;
                maskData.data[i * 4 + 2] = 0;
                maskData.data[i * 4 + 3] = 255; 
            }
            totalPixels++;
        }

        // Dessiner cercle d'exclusion sur le masque pour visualisation
        // (Note: on ne peut pas dessiner vectoriel sur ImageData, on le fera apr√®s le putImageData si besoin)
        
        ctxM.putImageData(maskData, 0, 0);

        // Stats
        let ratio = (greenCount / (320*240 - (Math.PI*exclusionRadius*exclusionRadius))) * 100;
        document.getElementById('weed-stats').innerText = `Herbes: ${ratio.toFixed(1)}%`;

        if(ratio > 35) {
             document.getElementById('weed-stats').style.color = "red";
             // log("ALERTE: Trop de mauvaises herbes !");
        } else {
             document.getElementById('weed-stats').style.color = "black";
        }

        requestAnimationFrame(processVideo);
    }

    // --- 3. COMMUNICATION (Simulation G-CODE) ---
    function startPlantingSequence() {
        log("G√©n√©ration du G-Code de semis...");
        // Exemple simple : envoi vers case (0,0) puis (1,0)
        // En r√©el : envoyer via WebSerial
        log("TX: G0 X250 Y125 Z0"); 
        robot.targetX = 250; robot.targetY = 125; // Simule le mouvement
        
        setTimeout(() => {
            log("TX: G1 Z-400 (Descente)");
            robot.z = -400; // Simule descente (Devient ROUGE)
        }, 2000);
        
        setTimeout(() => {
            log("TX: G0 Z0 (Mont√©e)");
            robot.z = 0; // Simule mont√©e (Devient BLEU)
        }, 4000);
    }

    function emergencyStop() {
        log("‚õî STOP ENVNOY√â !");
        // En vrai : M112
    }

    initGrid();
</script>
</body>
</html>
